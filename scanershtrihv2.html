<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            background: black;
            color: white;
            font-family: sans-serif;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        #scanner-container {
            width: 100%;
            height: 100vh;
            position: relative;
            display: none;
        }

        #warning {
            text-align: center;
            padding: 20px;
        }

        button {
            background-color: #0088cc;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="warning">
        <h2>–í–Ω–∏–º–∞–Ω–∏–µ</h2>
        <p>–í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Telegram Mini App. –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.</p>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∫–∞–Ω–µ—Ä –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–∞–º–µ—Ä—ã.</p>
        <button id="openInBrowser">–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ</button>
    </div>

    <div id="scanner-container"></div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –æ—Ç–∫—Ä—ã—Ç –ª–∏ WebApp –≤ WebView
        function isInTelegramWebView() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            return /tgwebapp/i.test(userAgent) || /Telegram/i.test(userAgent);
        }

        const warningDiv = document.getElementById('warning');
        const scannerDiv = document.getElementById('scanner-container');
        const openInBrowserBtn = document.getElementById('openInBrowser');

        if (isInTelegramWebView()) {
            // –í WebView ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            warningDiv.style.display = 'block';
            scannerDiv.style.display = 'none';

            openInBrowserBtn.addEventListener('click', () => {
                // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –ü–û–õ–ù–´–ô URL –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–í–ê–ñ–ù–û!!!)
                window.open('https://qaps322.github.io/scan-tel-2451/scanershtrihv2.html', '_blank');
            });
        } else {
            // –í –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ ‚Üí –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä
            warningDiv.style.display = 'none';
            scannerDiv.style.display = 'block';

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        facingMode: "environment"
                    },
                },
                decoder: {
                    readers: [
                        "ean_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "code_128_reader"
                    ]
                },
                locate: true,
                numOfWorkers: navigator.hardwareConcurrency || 4
            }, function (err) {
                if (err) {
                    console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", err);
                    return;
                }
                console.log("‚úÖ –°–∫–∞–Ω–µ—Ä –≥–æ—Ç–æ–≤");
                Quagga.start();
            });

            Quagga.onDetected(function (result) {
                const code = result.codeResult.code;
                console.log("‚úÖ –®—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–∞–π–¥–µ–Ω:", code);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram WebApp (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
                if (window.Telegram && window.Telegram.WebApp) {
                    try {
                        window.Telegram.WebApp.sendData(code);
                        console.log("üì§ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram WebApp");
                    } catch (err) {
                        console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", err);
                    }
                }

                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è
                Quagga.stop();
            });
        }
    </script>
</body>
</html>
