<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ (html5-qrcode)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.4.1/html5-qrcode.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      color: white;
      font-family: sans-serif;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #reader {
      width: 100%;
      max-width: 500px;
      height: auto;
      margin-top: 10px;
    }
    #start-scan {
      padding: 15px 25px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      margin-bottom: 20px;
    }
    #log {
      font-size: 14px;
      margin-top: 10px;
      color: #00ff00;
    }
  </style>
</head>
<body>

  <button id="start-scan">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
  <div id="reader" style="display: none;"></div>
  <div id="log"></div>

  <script>
    const TelegramWebApp = window.Telegram.WebApp;
    TelegramWebApp?.ready();

    function log(msg) {
      document.getElementById('log').innerText += msg + '\n';
    }

    const html5QrCode = new Html5Qrcode("reader");

    document.getElementById('start-scan').addEventListener('click', () => {
      document.getElementById('reader').style.display = 'block';
      document.getElementById('start-scan').style.display = 'none';

      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          log("‚úÖ –ö–∞–º–µ—Ä—ã –Ω–∞–π–¥–µ–Ω—ã: " + cameras.length);
          const cameraId = cameras[0].id;

          html5QrCode.start(
            cameraId,
            {
              fps: 10,
              qrbox: { width: 250, height: 150 },
              formatsToSupport: [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.CODE_128
              ]
            },
            (decodedText, decodedResult) => {
              log("‚úÖ –ù–∞–π–¥–µ–Ω –∫–æ–¥: " + decodedText);
              html5QrCode.stop().then(() => {
                log("‚õîÔ∏è –°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
                if (TelegramWebApp && TelegramWebApp.sendData) {
                  try {
                    TelegramWebApp.sendData(decodedText);
                    log("üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram");
                    TelegramWebApp.close();
                  } catch (e) {
                    log("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e);
                  }
                }
              });
            },
            (errorMessage) => {
              // –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–º–æ–∂–Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, –Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –æ—Å—Ç–∞–≤–∏–º)
              // log("‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: " + errorMessage);
            }
          );
        } else {
          log("‚ùå –ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
        }
      }).catch(err => {
        log("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–µ—Ä: " + err);
      });
    });
  </script>

</body>
</html>
