<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      color: white;
      font-family: sans-serif;
      height: 100%;
      overflow: hidden;
    }
    #scanner-container {
      width: 100%;
      height: 100vh;
      position: relative;
    }
    #interactive {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: relative;
    }
    #overlay {
      position: absolute;
      top: 20%;
      left: 15%;
      width: 70%;
      height: 30%;
      border: 2px dashed #00ff00;
      box-sizing: border-box;
      z-index: 10;
      pointer-events: none;
    }
    #area-highlight {
      position: absolute;
      top: 20%;
      left: 15%;
      width: 70%;
      height: 30%;
      border: 2px solid rgba(255, 0, 0, 0.7);
      background: rgba(255, 0, 0, 0.2);
      box-sizing: border-box;
      z-index: 9;
      pointer-events: none;
    }
    #log {
      position: fixed;
      bottom: 10px;
      left: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: #00ff00;
      font-family: monospace;
      padding: 10px;
      font-size: 14px;
      z-index: 9999;
      max-height: 120px;
      overflow-y: auto;
    }
    #start-scan {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 9999;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="scanner-container">
    <div id="interactive" class="viewport"></div>
    <div id="overlay"></div>
    <div id="area-highlight"></div>
  </div>

  <button id="start-scan">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
  <div id="log"></div>

  <script>
    const TelegramWebApp = window.Telegram.WebApp;
    TelegramWebApp?.ready();

    function logToScreen(msg) {
      const logDiv = document.getElementById('log');
      logDiv.innerText += msg + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        logToScreen("‚úÖ –ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞");
        stream.getTracks().forEach(track => track.stop());
      })
      .catch(err => {
        logToScreen("‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: " + err.name + " - " + err.message);
      });

    let sent = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Quagga (–Ω–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É!)
    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector('#interactive'),
        constraints: {
          facingMode: "environment"
        },
        area: {
          top: "20%",
          bottom: "50%",
          left: "15%",
          right: "15%"
        }
      },
      decoder: {
        readers: [
          "ean_reader",
          "upc_reader",
          "upc_e_reader",
          "code_128_reader"
        ]
      },
      locate: true
    }, function(err) {
      if (err) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", err);
        logToScreen("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: " + err);
        return;
      }
      logToScreen("‚úÖ Quagga –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    });

    // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
    document.getElementById('start-scan').addEventListener('click', function() {
      Quagga.start();
      logToScreen("üì∑ –°–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω –≤—Ä—É—á–Ω—É—é");

      setTimeout(() => {
        const video = document.querySelector("video");
        if (video) {
          video.setAttribute("playsinline", "");
          video.setAttribute("muted", "");
          video.setAttribute("autoplay", "");
          video.controls = false;
          video.removeAttribute("controls");
          console.log("üéØ –í–∏–¥–µ–æ-–∞—Ç—Ä–∏–±—É—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã");
          logToScreen("üéØ –í–∏–¥–µ–æ –Ω–∞–π–¥–µ–Ω–æ");
        } else {
          logToScreen("‚ö†Ô∏è –í–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!");
        }
      }, 500);
    });

    Quagga.onProcessed(function(result) {
      logToScreen("üõ† Frame processed: " + (result ? "‚úÖ" : "‚ùå"));
    });

    Quagga.onDetected(function(data) {
      if (sent) return;

      const code = data.codeResult.code;
      console.log("‚úÖ –ù–∞–π–¥–µ–Ω —à—Ç—Ä–∏—Ö–∫–æ–¥:", code);
      logToScreen("‚úÖ –ù–∞–π–¥–µ–Ω —à—Ç—Ä–∏—Ö–∫–æ–¥: " + code);
      sent = true;

      Quagga.stop();
      logToScreen("‚õîÔ∏è –°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");

      if (TelegramWebApp && TelegramWebApp.sendData) {
        try {
          TelegramWebApp.sendData(code);
          console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram");
          logToScreen("üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram");
        } catch (e) {
          console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", e);
          logToScreen("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e);
        }
      }
    });
  </script>
</body>
</html>
