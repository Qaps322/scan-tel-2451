<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ (html5-qrcode)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      color: white;
      font-family: sans-serif;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    #reader {
      width: 100%;
      max-width: 500px;
      height: auto;
      margin-top: 10px;
    }
    #log {
      width: 100%;
      max-width: 500px;
      background: rgba(0, 0, 0, 0.8);
      color: #00ff00;
      font-family: monospace;
      padding: 10px;
      font-size: 14px;
      margin-top: 10px;
      overflow-y: auto;
      max-height: 200px;
      border: 1px solid #00ff00;
    }
  </style>
</head>
<body>

  <div id="reader"></div>
  <div id="log">üü¢ –õ–æ–≥ —Å–∫–∞–Ω–µ—Ä–∞:\n</div>

  <script>
    const TelegramWebApp = window.Telegram.WebApp;
    TelegramWebApp?.ready();

    function log(msg) {
      const logDiv = document.getElementById('log');
      logDiv.innerText += msg + '\n';
      logDiv.scrollTop = logDiv.scrollHeight; // –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
      console.log(msg); // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –≤ –∫–æ–Ω—Å–æ–ª—å
    }

    const html5QrCode = new Html5Qrcode("reader");

    function startScanner() {
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          log("‚úÖ –ö–∞–º–µ—Ä—ã –Ω–∞–π–¥–µ–Ω—ã: " + cameras.length);
          const cameraId = cameras[0].id;

          html5QrCode.start(
            cameraId,
            {
              fps: 10,
              qrbox: { width: 250, height: 150 },
              formatsToSupport: [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.CODE_128
              ]
            },
            (decodedText, decodedResult) => {
              log("‚úÖ –ù–∞–π–¥–µ–Ω –∫–æ–¥: " + decodedText);
              html5QrCode.stop().then(() => {
                log("‚õîÔ∏è –°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
                if (TelegramWebApp && TelegramWebApp.sendData) {
                  try {
                    TelegramWebApp.sendData(decodedText);
                    log("üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram");
                    TelegramWebApp.close();
                  } catch (e) {
                    log("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e);
                  }
                }
              });
            },
            (errorMessage) => {
              // –ü–æ–∫–∞–∂–µ–º –≤ –ª–æ–≥–∞—Ö –æ—à–∏–±–∫–∏ –ø–æ —Ñ—Ä–µ–π–º–∞–º
              log("‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: " + errorMessage);
            }
          );
        } else {
          log("‚ùå –ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
        }
      }).catch(err => {
        log("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–µ—Ä: " + err);
      });
    }

    // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', () => {
      log("üöÄ –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞...");
      startScanner();
    });
  </script>

</body>
</html>
